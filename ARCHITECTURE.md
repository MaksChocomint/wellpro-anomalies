# Архитектурная диаграмма WellPro после рефакторинга

## 🎯 Иерархия компонентов

```
┌─────────────────────────────────────────────────────────────┐
│                    page.tsx (ГЛАВНЫЙ)                       │
│                    280 строк                                │
│                                                             │
│  • Управление состоянием                                   │
│  • Инициализация хуков                                     │
│  • Обработка событий                                       │
│  • Координация компонентов                                 │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
    ┌────────┐  ┌────────┐  ┌────────┐
    │GraphGrid  │Analysis  │ Control │
    │        │  │Selector  │Buttons │
    └────────┘  └────────┘  └────────┘
```

## 🔗 Поток данных

```
┌─────────────────────────────────────────────────────────────┐
│                         page.tsx                             │
│                                                              │
│  State:  liveData, anomalyInfo, analysisMethod, etc        │
└────────────────────┬─────────────────────────────────────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
┌──────────┐   ┌──────────┐   ┌──────────┐
│useWebSocket   │useData   │   │useThresh │
│              │Simulation│   │olds      │
│connectWeb     │start/stop│   │change    │
│Socket        │Simulation│   │Threshold │
└──────────┘   └──────────┘   └──────────┘
     │               │               │
     └───────────────┼───────────────┘
                     │
                     ▼
          Передача Props ↓
     ┌───────────────┼───────────────┐
     │               │               │
     ▼               ▼               ▼
┌──────────┐   ┌──────────┐   ┌──────────┐
│   Graph  │   │ Analysis │   │ Control  │
│  Grid    │   │ Selector │   │ Buttons  │
└──────────┘   └──────────┘   └──────────┘
```

## 📊 Связи между компонентами

```
                    ┌─────────────────┐
                    │   useWebSocket  │
                    │                 │
                    │ • connectWeb    │
                    │ • wsRef         │
                    │ • onMessage     │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    │                    ▼
  Получение данных   Обновление       Установка параметров
  в реальном времени    состояния       на сервер
        │                  │                      │
        └──────────┬───────┴──────────┬──────────┘
                   │                  │
                   ▼                  ▼
        ┌──────────────────────────────────┐
        │         page.tsx State            │
        │                                   │
        │  • liveData                       │
        │  • anomalyInfo                    │
        │  • analysisMethod                 │
        │  • thresholds                     │
        │  • isBackendConnected             │
        └──────────────────────────────────┘
                   │
        ┌──────────┼──────────┐
        │          │          │
        ▼          ▼          ▼
   GraphGrid  Analysis   ControlButtons
   (графики)  Selector  (кнопки)
```

## 🧩 Взаимодействие хуков

```
┌──────────────────┐         ┌──────────────────┐
│  useWebSocket    │         │ useDataSimulation│
│                  │         │                  │
│ connectWebSocket │         │ startDataSim     │
│ wsRef            │         │ stopSimulation   │
│ message handler  │         │ fullDataRef      │
└────────┬─────────┘         └────────┬─────────┘
         │                           │
         │   Оба обновляют:          │
         │                           │
         └───────────┬───────────────┘
                     │
        ┌────────────▼────────────┐
        │   liveData (State)      │
        │                         │
        │ от WebSocket ИЛИ        │
        │ от Simulation           │
        └────────────┬────────────┘
                     │
                     ▼
        ┌──────────────────────┐
        │  GraphGrid Component  │
        │  (отображение)        │
        └──────────────────────┘
```

## 📈 Поток логики анализа

```
                  ┌─────────────────┐
                  │ Загрузка файла  │
                  └────────┬────────┘
                           │
                           ▼
        ┌──────────────────────────────────┐
        │   fileUtils.analyzeFile()        │
        │   (отправить на backend API)     │
        └──────────────────────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────┐
        │   Backend анализирует файл       │
        │   (FFT / Z-score / LOF)          │
        └──────────────────────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────┐
        │   Результаты анализа             │
        │   (данные + аномалии)            │
        └──────────────────────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────┐
        │   fullDataRef ← parsedData       │
        │   (сохраняем для симуляции)      │
        └──────────────────────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────┐
        │  startDataSimulation()           │
        │  (подаем данные по 1 точке)      │
        └──────────────────────────────────┘
                           │
                           ▼
        ┌──────────────────────────────────┐
        │   liveData обновляется           │
        │   (GraphGrid перерисовывается)   │
        └──────────────────────────────────┘
```

## 🔄 Переключение режимов

```
        ┌─────────────────────┐
        │ Real-time Режим     │
        │                     │
        │ • useWebSocket      │
        │ • получение данных  │
        │ • анализ на сервере │
        │ • WSconnected=true  │
        └──────────┬──────────┘
                   │
            Нажата кнопка
      "Режим Real-time"
                   │
                   ▼
        ┌─────────────────────┐
        │ Симуляция Режим     │
        │                     │
        │ • useDataSimulation │
        │ • загрузка файла    │
        │ • воспроизведение   │
        │ • WSconnected=false │
        └─────────────────────┘
```

## 🎛️ Управление параметрами анализа

```
┌─────────────────────────────────────┐
│  AnalysisMethodSelector             │
│  (выбор метода + настройки)         │
└────────────────┬────────────────────┘
                 │
        ┌────────┴────────┐
        │                 │
        ▼                 ▼
    ┌─────────┐      ┌──────────┐
    │ Выбор   │      │ Изменение│
    │ метода  │      │ порогов  │
    └────┬────┘      └────┬─────┘
         │                │
         │  handleThreshold
         │  Change()
         │                │
         └────────┬───────┘
                  │
                  ▼
      ┌───────────────────────┐
      │ thresholdsRef ←       │
      │ новые значения        │
      └───────────┬───────────┘
                  │
                  ▼
    ┌─────────────────────────┐
    │ isBackendConnected?     │
    └──────┬────────┬─────────┘
           │ YES    │ NO
           ▼        ▼
      Отправить  Сохранить
      на сервер  в локальное
                 состояние
```

## 📦 Зависимости между модулями

```
page.tsx
├── useWebSocket (пользуется)
│   └── buildParametersMessage (импортирует)
├── useDataSimulation (пользуется)
├── analyzeFile (импортирует)
├── extractFlightStartTimeFromFile (импортирует)
├── buildParametersMessage (импортирует)
├── AnalysisMethodSelector (рендерит)
├── GraphGrid (рендерит)
├── ControlButtons (рендерит)
└── Существующие компоненты
    ├── AnomalyModal
    ├── StatusDisplay
    ├── GraphControls
    └── LoadingOverlay

fileUtils.ts
├── axios (импортирует для API)
└── types (для типизации)

thresholdUtils.ts
└── types (для типизации)

GraphGrid.tsx
├── react-plotly.js (для графиков)
└── utils.ts (для форматирования)
```

## 🚀 Производительность

```
БЫЛО (Монолит page.tsx - 835 строк):
├── Один большой компонент
├── Сложно переиспользовать
├── Сложно тестировать
└── Много логики в одном месте

СТАЛО (Рефакторен):
├── 3 компонента (184 строк)
├── 3 хука (280 строк)
├── 2 утилиты (90 строк)
├── Легко переиспользовать
├── Легко тестировать
└── Разделение ответственности
```

---

**Архитектура готова к расширению! ✨**
